<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule34 批量上传工具</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #111;
            color: #fafafa;
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .container {
            max-width: 1200px;
        }
        
        .card {
            background-color: #1a1a1a;
            border: 1px solid #333;
        }
        
        .btn-primary {
            background-color: #4caf50;
            border-color: #4caf50;
        }
        
        .btn-primary:hover {
            background-color: #45a049;
            border-color: #45a049;
        }
        
        .metadata-preview {
            max-height: 400px;
            overflow-y: auto;
            background-color: #0a0a0a;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .upload-item {
            background-color: #1a1a1a;
            border: 1px solid #333;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .upload-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        
        .upload-item .info {
            flex: 1;
        }
        
        .upload-item .status {
            min-width: 100px;
            text-align: center;
        }
        
        .tag-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            margin: 0.1rem;
            background-color: #333;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .tag-badge.artist {
            background-color: #9c27b0;
        }
        
        .tag-badge.character {
            background-color: #2196f3;
        }
        
        .tag-badge.copyright {
            background-color: #ff9800;
        }
        
        .progress-info {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">
            <i class="bi bi-cloud-upload"></i> Rule34 批量上传工具
        </h1>
        
        <!-- 步骤1：Supabase连接 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="badge bg-primary">步骤 1</span> 连接 Supabase
                </h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Supabase URL</label>
                        <input type="text" class="form-control" id="supabaseUrl" 
                               placeholder="https://xxxxx.supabase.co">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Anon Key</label>
                        <input type="text" class="form-control" id="supabaseKey" 
                               placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="testConnection()">
                            <i class="bi bi-link-45deg"></i> 测试连接
                        </button>
                        <span id="connectionStatus" class="ms-3"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 步骤2：导入元数据 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="badge bg-primary">步骤 2</span> 导入元数据
                </h5>
                <div class="mb-3">
                    <label class="form-label">选择 metadata.json 文件</label>
                    <input type="file" class="form-control" id="metadataFile" accept=".json">
                </div>
                <div class="mb-3">
                    <label class="form-label">选择图片文件夹</label>
                    <input type="file" class="form-control" id="imagesFolder" webkitdirectory directory multiple>
                </div>
                <div class="metadata-preview" id="metadataPreview" style="display: none;">
                    <!-- 元数据预览 -->
                </div>
            </div>
        </div>
        
        <!-- 步骤3：批量上传 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="badge bg-primary">步骤 3</span> 批量上传
                </h5>
                <div class="mb-3">
                    <label class="form-label">默认分类</label>
                    <select class="form-select" id="defaultCategory">
                        <option value="anime">anime</option>
                        <option value="western">western</option>
                        <option value="furry">furry</option>
                        <option value="game">game</option>
                        <option value="comic">comic</option>
                        <option value="photo">photo</option>
                        <option value="3d">3d</option>
                        <option value="ai">ai</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-lg" onclick="startBatchUpload()" id="uploadBtn" disabled>
                    <i class="bi bi-cloud-upload"></i> 开始批量上传
                </button>
                <button class="btn btn-secondary btn-lg ms-2" onclick="pauseUpload()" id="pauseBtn" style="display: none;">
                    <i class="bi bi-pause"></i> 暂停
                </button>
            </div>
        </div>
        
        <!-- 上传列表 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">上传队列</h5>
                <div id="uploadList">
                    <!-- 上传项目列表 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 进度信息 -->
    <div class="progress-info" id="progressInfo" style="display: none;">
        <h6>上传进度</h6>
        <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                 id="progressBar" style="width: 0%"></div>
        </div>
        <div id="progressText">0 / 0</div>
    </div>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        let supabase = null;
        let metadata = [];
        let imageFiles = {};
        let uploadQueue = [];
        let isUploading = false;
        let currentIndex = 0;
        
        // 测试连接
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                alert('请填写完整的连接信息');
                return;
            }
            
            try {
                const { createClient } = window.supabase;
                supabase = createClient(url, key);
                
                const { data, error } = await supabase
                    .from('images')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="text-success"><i class="bi bi-check-circle"></i> 连接成功</span>';
                
                checkUploadReady();
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="text-danger"><i class="bi bi-x-circle"></i> 连接失败: ' + error.message + '</span>';
            }
        }
        
        // 处理元数据文件
        document.getElementById('metadataFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                metadata = JSON.parse(text);
                
                // 显示预览
                const preview = document.getElementById('metadataPreview');
                preview.style.display = 'block';
                preview.innerHTML = `<pre>${JSON.stringify(metadata, null, 2)}</pre>`;
                
                // 创建上传列表
                updateUploadList();
                checkUploadReady();
                
            } catch (error) {
                alert('读取元数据失败: ' + error.message);
            }
        });
        
        // 处理图片文件夹
        document.getElementById('imagesFolder').addEventListener('change', (e) => {
            const files = e.target.files;
            imageFiles = {};
            
            for (const file of files) {
                imageFiles[file.name] = file;
            }
            
            console.log(`已加载 ${Object.keys(imageFiles).length} 个图片文件`);
            checkUploadReady();
        });
        
        // 更新上传列表
        function updateUploadList() {
            const list = document.getElementById('uploadList');
            list.innerHTML = '';
            
            metadata.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'upload-item';
                div.id = `upload-item-${index}`;
                
                // 生成标签HTML
                let tagsHtml = '';
                if (item.tags) {
                    if (item.tags.artist && item.tags.artist.length > 0) {
                        item.tags.artist.forEach(tag => {
                            tagsHtml += `<span class="tag-badge artist">艺术家: ${tag}</span>`;
                        });
                    }
                    if (item.tags.character && item.tags.character.length > 0) {
                        item.tags.character.slice(0, 3).forEach(tag => {
                            tagsHtml += `<span class="tag-badge character">角色: ${tag}</span>`;
                        });
                    }
                    if (item.tags.copyright && item.tags.copyright.length > 0) {
                        item.tags.copyright.slice(0, 2).forEach(tag => {
                            tagsHtml += `<span class="tag-badge copyright">版权: ${tag}</span>`;
                        });
                    }
                }
                
                div.innerHTML = `
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='%23333'/%3E%3C/svg%3E" 
                         alt="${item.filename}">
                    <div class="info">
                        <div class="fw-bold">${item.filename}</div>
                        <div class="text-muted small">ID: ${item.id} | ${item.width}x${item.height}</div>
                        <div class="mt-1">${tagsHtml}</div>
                    </div>
                    <div class="status">
                        <span class="badge bg-secondary">等待中</span>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }
        
        // 检查是否可以开始上传
        function checkUploadReady() {
            const ready = supabase && metadata.length > 0 && Object.keys(imageFiles).length > 0;
            document.getElementById('uploadBtn').disabled = !ready;
        }
        
        // 开始批量上传
        async function startBatchUpload() {
            if (isUploading) return;
            
            isUploading = true;
            currentIndex = 0;
            
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('progressInfo').style.display = 'block';
            
            const defaultCategory = document.getElementById('defaultCategory').value;
            
            // 开始逐个上传
            for (let i = currentIndex; i < metadata.length && isUploading; i++) {
                currentIndex = i;
                await uploadSingleImage(i, defaultCategory);
                updateProgress(i + 1, metadata.length);
            }
            
            if (currentIndex >= metadata.length - 1) {
                alert('批量上传完成！');
                resetUpload();
            }
        }
        
        // 上传单个图片
        async function uploadSingleImage(index, defaultCategory) {
            const item = metadata[index];
            const imageFile = imageFiles[item.filename];
            
            const statusEl = document.querySelector(`#upload-item-${index} .status`);
            statusEl.innerHTML = '<span class="badge bg-warning">上传中...</span>';
            
            if (!imageFile) {
                statusEl.innerHTML = '<span class="badge bg-danger">文件未找到</span>';
                return;
            }
            
            try {
                // 上传到存储桶
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('rule')
                    .upload(item.filename, imageFile);
                
                if (uploadError) throw uploadError;
                
                // 插入数据库记录
                const { error: dbError } = await supabase
                    .from('images')
                    .insert({
                        file_path: `rule/${item.filename}`,
                        category: item.category || defaultCategory,
                        tags: item.supabase_tags || item.tags.all
                    });
                
                if (dbError) throw dbError;
                
                statusEl.innerHTML = '<span class="badge bg-success">已上传</span>';
                
                // 显示缩略图
                const imgEl = document.querySelector(`#upload-item-${index} img`);
                imgEl.src = URL.createObjectURL(imageFile);
                
            } catch (error) {
                statusEl.innerHTML = `<span class="badge bg-danger">失败: ${error.message}</span>`;
                console.error('上传失败:', error);
            }
            
            // 延迟避免请求过快
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // 更新进度
        function updateProgress(current, total) {
            const percentage = (current / total * 100).toFixed(0);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${current} / ${total}`;
        }
        
        // 暂停上传
        function pauseUpload() {
            isUploading = false;
            document.getElementById('uploadBtn').style.display = 'inline-block';
            document.getElementById('uploadBtn').textContent = '继续上传';
            document.getElementById('pauseBtn').style.display = 'none';
        }
        
        // 重置上传
        function resetUpload() {
            isUploading = false;
            currentIndex = 0;
            document.getElementById('uploadBtn').style.display = 'inline-block';
            document.getElementById('uploadBtn').textContent = '开始批量上传';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('progressInfo').style.display = 'none';
        }
    </script>
</body>
</html> 