<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule34 ä¸­è½¬ç«™</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d4a35 50%, #1a1a1a 100%);
            color: #fafafa;
            min-height: 100vh;
            padding: 2rem 0;
            font-family: 'Inter', sans-serif;
        }
        
        body, .form-control, .form-select, .card-title, .form-label {
            color: #fff !important;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .form-control, .form-select {
            background-color: #232b2b !important;
            border: 1.5px solid #4caf50 !important;
        }
        .form-label {
            color: #b2ffb2 !important;
            font-weight: 600;
        }
        .card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 24px rgba(76,175,80,0.12);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            border: none;
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            border-radius: 10px;
        }
        
        .status-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: rgba(26, 26, 26, 0.5);
            border-radius: 8px;
            border-left: 3px solid #4caf50;
        }
        
        .status-item.processing {
            border-left-color: #ff9800;
            animation: pulse 2s infinite;
        }
        
        .status-item.success {
            border-left-color: #4caf50;
        }
        
        .status-item.error {
            border-left-color: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .tag-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            margin: 0.1rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .tag-artist { background: linear-gradient(45deg, #9c27b0, #ba68c8); }
        .tag-character { background: linear-gradient(45deg, #2196f3, #64b5f6); }
        .tag-copyright { background: linear-gradient(45deg, #ff9800, #ffb74d); }
        .tag-general { background: linear-gradient(45deg, #607d8b, #90a4ae); }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            text-align: center;
            padding: 1.5rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4caf50;
        }
        
        .config-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: rgba(26, 26, 26, 0.9);
            border-color: #4caf50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            color: #fafafa;
        }
        
        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="display-4 fw-bold mb-2">
                <i class="bi bi-cloud-arrow-up text-success"></i> Rule34 ä¸­è½¬ç«™
            </h1>
            <p class="lead">è‡ªåŠ¨çˆ¬å–å¹¶ä¸Šä¼ åˆ°ç”»å»Š - ä¸€é”®å¼è§£å†³æ–¹æ¡ˆ</p>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalProcessed">0</div>
                    <div>å·²å¤„ç†</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalSuccess">0</div>
                    <div>ä¸Šä¼ æˆåŠŸ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalSkipped">0</div>
                    <div>å·²è·³è¿‡</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalErrors">0</div>
                    <div>é”™è¯¯</div>
                </div>
            </div>
        </div>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-gear"></i> é…ç½®è®¾ç½®
                </h5>
                
                <!-- Supabaseé…ç½® -->
                <div class="config-section">
                    <h6>Supabase é…ç½®</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="supabaseUrl" 
                                   placeholder="Supabase URL" value="https://ibehtwiqwopghgeblflg.supabase.co">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="supabaseKey" 
                                   placeholder="Anon Key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliZWh0d2lxd29wZ2hnZWJsZmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDM1NzYsImV4cCI6MjA2Mzk3OTU3Nn0.yQaK5fo25uU_sDWAnMQilGAsoX4v4uY2eemt5SVg5tI">
                        </div>
                    </div>
                </div>
                
                <!-- çˆ¬å–é…ç½® -->
                <div class="config-section">
                    <h6>çˆ¬å–é…ç½®</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">æœç´¢æ ‡ç­¾</label>
                            <input type="text" class="form-control" id="searchTags" 
                                   placeholder="ä¾‹å¦‚: score:>100 æˆ–ç•™ç©ºçˆ¬å–å…¨éƒ¨" value="">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">æ¯æ‰¹æ•°é‡</label>
                            <select class="form-select" id="batchSize">
                                <option value="10">10å¼ </option>
                                <option value="20" selected>20å¼ </option>
                                <option value="50">50å¼ </option>
                                <option value="100">100å¼ </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">å¼€å§‹é¡µç </label>
                            <input type="number" class="form-control" id="startPage" value="0" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- è¿‡æ»¤é…ç½® -->
                <div class="config-section">
                    <h6>è¿‡æ»¤è®¾ç½®</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">æœ€ä½è¯„åˆ†</label>
                            <input type="number" class="form-control" id="minScore" value="0" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">å†…å®¹è¯„çº§</label>
                            <select class="form-select" id="allowedRatings" multiple>
                                <option value="s" selected>Safe (å®‰å…¨)</option>
                                <option value="q" selected>Questionable (å¯ç–‘)</option>
                                <option value="e" selected>Explicit (æ˜ç¡®)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">è·³è¿‡å·²å­˜åœ¨</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="skipExisting" checked>
                                <label class="form-check-label" for="skipExisting">
                                    è‡ªåŠ¨è·³è¿‡å·²ä¸Šä¼ çš„å›¾ç‰‡
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å­˜å‚¨æ¡¶é…ç½® -->
                <div class="config-section">
                    <h6>å­˜å‚¨æ¡¶é…ç½®</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="supabaseBucket" 
                                   placeholder="å­˜å‚¨æ¡¶åç§°" value="rule">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-play-circle"></i> æ§åˆ¶é¢æ¿
                    </h5>
                    <div>
                        <button class="btn btn-primary me-2" onclick="testConnection()">
                            <i class="bi bi-wifi"></i> æµ‹è¯•è¿æ¥
                        </button>
                        <button class="btn btn-success" onclick="startCrawling()" id="startBtn">
                            <i class="bi bi-play-fill"></i> å¼€å§‹çˆ¬å–ä¸Šä¼ 
                        </button>
                        <button class="btn btn-warning" onclick="pauseCrawling()" id="pauseBtn" style="display:none;">
                            <i class="bi bi-pause-fill"></i> æš‚åœ
                        </button>
                        <button class="btn btn-danger" onclick="stopCrawling()" id="stopBtn" style="display:none;">
                            <i class="bi bi-stop-fill"></i> åœæ­¢
                        </button>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>å¤„ç†è¿›åº¦</span>
                        <span id="progressText">0 / 0</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- å½“å‰çŠ¶æ€ -->
                <div class="row">
                    <div class="col-md-6">
                        <strong>å½“å‰çŠ¶æ€ï¼š</strong>
                        <span id="currentStatus" class="text-muted">å¾…æœºä¸­</span>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>é€Ÿåº¦ï¼š</strong>
                        <span id="processingSpeed" class="text-info">- å¼ /åˆ†é’Ÿ</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¤„ç†æ—¥å¿— -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul"></i> å¤„ç†æ—¥å¿—
                    </h5>
                    <button class="btn btn-outline-light btn-sm" onclick="clearLog()">
                        <i class="bi bi-trash"></i> æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
                <div class="status-container" id="statusLog">
                    <div class="text-muted text-center">ç­‰å¾…å¼€å§‹å¤„ç†...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let supabase = null;
        let isRunning = false;
        let isPaused = false;
        let shouldStop = false;
        let currentPage = 0;
        let stats = {
            processed: 0,
            success: 0,
            skipped: 0,
            errors: 0
        };
        let startTime = null;
        let existingHashes = new Set();
        
        // åˆå§‹åŒ–è¿æ¥æµ‹è¯•
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                alert('è¯·å¡«å†™Supabaseè¿æ¥ä¿¡æ¯');
                return false;
            }
            
            try {
                const { createClient } = window.supabase;
                supabase = createClient(url, key);
                
                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabase
                    .from('images')
                    .select('id, md5')
                    .limit(1);
                
                if (error) throw error;
                
                addLog('success', 'âœ… Supabaseè¿æ¥æˆåŠŸ');
                
                // åŠ è½½å·²å­˜åœ¨çš„å›¾ç‰‡MD5
                await loadExistingHashes();
                
                return true;
            } catch (error) {
                addLog('error', `âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }
        
        // åŠ è½½å·²å­˜åœ¨çš„å›¾ç‰‡MD5
        async function loadExistingHashes() {
            try {
                addLog('processing', 'ğŸ“‹ åŠ è½½å·²å­˜åœ¨å›¾ç‰‡åˆ—è¡¨...');
                
                let allHashes = [];
                let from = 0;
                const batchSize = 1000;
                
                while (true) {
                    const { data, error } = await supabase
                        .from('images')
                        .select('md5')
                        .range(from, from + batchSize - 1);
                    
                    if (error) throw error;
                    
                    if (data.length === 0) break;
                    
                    allHashes = allHashes.concat(data.map(item => item.md5).filter(md5 => md5));
                    from += batchSize;
                }
                
                existingHashes = new Set(allHashes);
                addLog('success', `ğŸ“š å·²åŠ è½½ ${existingHashes.size} ä¸ªå·²å­˜åœ¨å›¾ç‰‡çš„MD5`);
                
            } catch (error) {
                addLog('error', `âŒ åŠ è½½å·²å­˜åœ¨å›¾ç‰‡å¤±è´¥: ${error.message}`);
            }
        }
        
        // å¼€å§‹çˆ¬å–
        async function startCrawling() {
            if (!(await testConnection())) return;
            
            if (isRunning) return;
            
            isRunning = true;
            isPaused = false;
            shouldStop = false;
            startTime = Date.now();
            
            // é‡ç½®ç»Ÿè®¡
            stats = { processed: 0, success: 0, skipped: 0, errors: 0 };
            updateStats();
            
            // æ›´æ–°UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('currentStatus').textContent = 'æ­£åœ¨çˆ¬å–ä¸­...';
            
            currentPage = parseInt(document.getElementById('startPage').value) || 0;
            
            addLog('processing', 'ğŸš€ å¼€å§‹çˆ¬å–Rule34å›¾ç‰‡...');
            
            try {
                await processBatch();
            } catch (error) {
                addLog('error', `âŒ çˆ¬å–è¿‡ç¨‹å‡ºé”™: ${error.message}`);
                stopCrawling();
            }
        }
        
        // å¤„ç†ä¸€æ‰¹å›¾ç‰‡
        async function processBatch() {
            while (isRunning && !shouldStop) {
                if (isPaused) {
                    await new Promise(resolve => {
                        const checkPause = () => {
                            if (!isPaused || shouldStop) {
                                resolve();
                            } else {
                                setTimeout(checkPause, 1000);
                            }
                        };
                        checkPause();
                    });
                    continue;
                }
                
                const batchSize = parseInt(document.getElementById('batchSize').value);
                const searchTags = document.getElementById('searchTags').value.trim();
                
                addLog('processing', `ğŸ“„ è·å–ç¬¬ ${currentPage + 1} é¡µæ•°æ® (æ¯é¡µ${batchSize}å¼ )...`);
                
                try {
                    // æ„å»ºRule34 APIè¯·æ±‚
                    const apiUrl = 'https://api.rule34.xxx/index.php';
                    const params = new URLSearchParams({
                        page: 'dapi',
                        s: 'post',
                        q: 'index',
                        limit: batchSize,
                        pid: currentPage
                    });
                    
                    if (searchTags) {
                        params.set('tags', searchTags);
                    }
                    
                    const response = await fetch(`${apiUrl}?${params}`, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    const posts = xmlDoc.getElementsByTagName('post');
                    
                    if (posts.length === 0) {
                        addLog('success', 'ğŸ æ²¡æœ‰æ›´å¤šå›¾ç‰‡ï¼Œçˆ¬å–å®Œæˆ');
                        stopCrawling();
                        break;
                    }
                    
                    addLog('success', `ğŸ“¦ è·å–åˆ° ${posts.length} å¼ å›¾ç‰‡ï¼Œå¼€å§‹å¤„ç†...`);
                    
                    // å¤„ç†æ¯å¼ å›¾ç‰‡
                    for (let i = 0; i < posts.length && isRunning && !shouldStop; i++) {
                        if (isPaused) break;
                        
                        const post = posts[i];
                        await processImage(post, i + 1, posts.length);
                        
                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / posts.length) * 100;
                        updateProgress(i + 1, posts.length, progress);
                        
                        // é¿å…è¯·æ±‚è¿‡å¿«
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    currentPage++;
                    
                } catch (error) {
                    addLog('error', `âŒ è·å–ç¬¬ ${currentPage + 1} é¡µå¤±è´¥: ${error.message}`);
                    stats.errors++;
                    updateStats();
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åç»§ç»­
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    currentPage++;
                }
            }
        }
        
        // å¤„ç†å•å¼ å›¾ç‰‡
        async function processImage(post, index, total) {
            const id = post.getAttribute('id');
            const md5 = post.getAttribute('md5');
            const fileUrl = post.getAttribute('file_url');
            const tags = post.getAttribute('tags') || '';
            const score = parseInt(post.getAttribute('score')) || 0;
            const rating = post.getAttribute('rating') || '';
            const width = post.getAttribute('width');
            const height = post.getAttribute('height');
            
            const logPrefix = `[${index}/${total}] ID:${id}`;
            
            try {
                // æ£€æŸ¥è¯„åˆ†è¿‡æ»¤
                const minScore = parseInt(document.getElementById('minScore').value) || 0;
                if (score < minScore) {
                    addLog('skipped', `${logPrefix} â­ï¸ è¯„åˆ†è¿‡ä½ (${score} < ${minScore})`);
                    stats.skipped++;
                    stats.processed++;
                    updateStats();
                    return;
                }
                
                // æ£€æŸ¥è¯„çº§è¿‡æ»¤
                const allowedRatings = Array.from(document.getElementById('allowedRatings').selectedOptions)
                    .map(option => option.value);
                if (!allowedRatings.includes(rating)) {
                    addLog('skipped', `${logPrefix} â­ï¸ è¯„çº§ä¸å…è®¸ (${rating})`);
                    stats.skipped++;
                    stats.processed++;
                    updateStats();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (document.getElementById('skipExisting').checked && md5 && existingHashes.has(md5)) {
                    addLog('skipped', `${logPrefix} â­ï¸ å·²å­˜åœ¨ (MD5: ${md5.substring(0, 8)}...)`);
                    stats.skipped++;
                    stats.processed++;
                    updateStats();
                    return;
                }
                
                addLog('processing', `${logPrefix} ğŸ”„ å¼€å§‹å¤„ç†...`);
                
                // åˆ†ç±»æ ‡ç­¾
                const categorizedTags = await categorizeTagsFromRule34(tags.split(' ').filter(tag => tag.trim()));
                
                // ä¸‹è½½å›¾ç‰‡
                const imageBlob = await downloadImage(fileUrl);
                if (!imageBlob) {
                    throw new Error('å›¾ç‰‡ä¸‹è½½å¤±è´¥');
                }
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileExt = fileUrl.split('.').pop().split('?')[0] || 'jpg';
                const filename = `${id}.${fileExt}`;
                
                // ä¸Šä¼ åˆ°Supabaseå­˜å‚¨ï¼ˆåªç”¨æ–‡ä»¶åï¼Œä¸å¸¦ä»»ä½•ç›®å½•ï¼‰
                const filePath = filename;
                const { error: uploadError } = await supabase.storage
                    .from(document.getElementById('supabaseBucket').value)
                    .upload(filePath, imageBlob, {
                        contentType: `image/${fileExt}`,
                        upsert: false
                    });
                
                if (uploadError) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadError.message}`);
                }
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const { error: dbError } = await supabase
                    .from('images')
                    .insert({
                        file_path: filePath,
                        original_filename: filename,
                        tags: categorizedTags.supabase_tags,
                        md5: md5,
                        rule34_id: id,
                        score: score,
                        rating: rating,
                        width: parseInt(width),
                        height: parseInt(height),
                        metadata: {
                            tags: categorizedTags,
                            rule34_url: `https://rule34.xxx/index.php?page=post&s=view&id=${id}`
                        }
                    });
                
                if (dbError) {
                    // å¦‚æœæ•°æ®åº“æ’å…¥å¤±è´¥ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶
                    await supabase.storage.from(document.getElementById('supabaseBucket').value).remove([filePath]);
                    throw new Error(`æ•°æ®åº“ä¿å­˜å¤±è´¥: ${dbError.message}`);
                }
                
                // æ·»åŠ åˆ°å·²å­˜åœ¨åˆ—è¡¨
                if (md5) {
                    existingHashes.add(md5);
                }
                
                addLog('success', `${logPrefix} âœ… ä¸Šä¼ æˆåŠŸ - ${categorizedTags.artist.length}è‰ºæœ¯å®¶, ${categorizedTags.character.length}è§’è‰², ${categorizedTags.copyright.length}ç‰ˆæƒ, ${categorizedTags.general.length}ä¸€èˆ¬æ ‡ç­¾`);
                
                stats.success++;
                stats.processed++;
                updateStats();
                
            } catch (error) {
                addLog('error', `${logPrefix} âŒ å¤„ç†å¤±è´¥: ${error.message}`);
                stats.errors++;
                stats.processed++;
                updateStats();
            }
        }
        
        // ä»Rule34æ ‡ç­¾åˆ†ç±»
        async function categorizeTagsFromRule34(tags) {
            const categorized = {
                artist: [],
                character: [],
                copyright: [],
                general: [],
                supabase_tags: []
            };
            
            // é€šè¿‡Rule34 APIè·å–æ ‡ç­¾ç±»å‹
            for (const tag of tags) {
                if (!tag.trim()) continue;
                
                try {
                    const apiUrl = 'https://api.rule34.xxx/index.php';
                    const params = new URLSearchParams({
                        page: 'dapi',
                        s: 'tag',
                        q: 'index',
                        name: tag
                    });
                    
                    const response = await fetch(`${apiUrl}?${params}`);
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    const tagElement = xmlDoc.getElementsByTagName('tag')[0];
                    
                    if (tagElement) {
                        const type = parseInt(tagElement.getAttribute('type')) || 0;
                        
                        switch (type) {
                            case 1: // artist
                                categorized.artist.push(tag);
                                categorized.supabase_tags.push(`artist:${tag}`);
                                break;
                            case 4: // character
                                categorized.character.push(tag);
                                categorized.supabase_tags.push(`character:${tag}`);
                                break;
                            case 3: // copyright
                                categorized.copyright.push(tag);
                                categorized.supabase_tags.push(`copyright:${tag}`);
                                break;
                            default: // general
                                categorized.general.push(tag);
                                categorized.supabase_tags.push(tag);
                                break;
                        }
                    } else {
                        categorized.general.push(tag);
                        categorized.supabase_tags.push(tag);
                    }
                    
                    // é¿å…APIè¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    // å¦‚æœè·å–æ ‡ç­¾ç±»å‹å¤±è´¥ï¼Œé»˜è®¤ä¸ºä¸€èˆ¬æ ‡ç­¾
                    categorized.general.push(tag);
                    categorized.supabase_tags.push(tag);
                }
            }
            
            return categorized;
        }
        
        // ä¸‹è½½å›¾ç‰‡
        async function downloadImage(url) {
            try {
                // é€šè¿‡æœ¬åœ°Pythonä»£ç†ä¸‹è½½å›¾ç‰‡ï¼Œè§£å†³CORSé—®é¢˜
                const proxyUrl = `http://localhost:5000/fetch_image?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.blob();
            } catch (error) {
                console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
                return null;
            }
        }
        
        // æš‚åœçˆ¬å–
        function pauseCrawling() {
            if (!isRunning) return;
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.innerHTML = '<i class="bi bi-play-fill"></i> ç»§ç»­';
                document.getElementById('currentStatus').textContent = 'å·²æš‚åœ';
                addLog('processing', 'â¸ï¸ çˆ¬å–å·²æš‚åœ');
            } else {
                pauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i> æš‚åœ';
                document.getElementById('currentStatus').textContent = 'æ­£åœ¨çˆ¬å–ä¸­...';
                addLog('processing', 'â–¶ï¸ çˆ¬å–å·²ç»§ç»­');
            }
        }
        
        // åœæ­¢çˆ¬å–
        function stopCrawling() {
            isRunning = false;
            shouldStop = true;
            isPaused = false;
            
            // æ›´æ–°UI
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('currentStatus').textContent = 'å·²åœæ­¢';
            
            addLog('processing', 'ğŸ›‘ çˆ¬å–å·²åœæ­¢');
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalProcessed').textContent = stats.processed;
            document.getElementById('totalSuccess').textContent = stats.success;
            document.getElementById('totalSkipped').textContent = stats.skipped;
            document.getElementById('totalErrors').textContent = stats.errors;
            
            // è®¡ç®—å¤„ç†é€Ÿåº¦
            if (startTime && stats.processed > 0) {
                const elapsed = (Date.now() - startTime) / 1000 / 60; // åˆ†é’Ÿ
                const speed = (stats.processed / elapsed).toFixed(1);
                document.getElementById('processingSpeed').textContent = `${speed} å¼ /åˆ†é’Ÿ`;
            }
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total, percentage) {
            document.getElementById('progressText').textContent = `${current} / ${total}`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const statusLog = document.getElementById('statusLog');
            const logItem = document.createElement('div');
            logItem.className = `status-item ${type}`;
            
            const time = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="flex-grow-1">
                    <span class="text-muted">[${time}]</span> ${message}
                </div>
            `;
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œæ¸…ç©ºå ä½ç¬¦
            if (statusLog.children.length === 1 && statusLog.children[0].classList.contains('text-muted')) {
                statusLog.innerHTML = '';
            }
            
            statusLog.appendChild(logItem);
            statusLog.scrollTop = statusLog.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (statusLog.children.length > 100) {
                statusLog.removeChild(statusLog.firstChild);
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('statusLog').innerHTML = '<div class="text-muted text-center">æ—¥å¿—å·²æ¸…ç©º</div>';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨æµ‹è¯•è¿æ¥
            // testConnection();
        });
    </script>
</body>
</html> 